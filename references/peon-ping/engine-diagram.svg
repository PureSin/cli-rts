<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 960 720" font-family="'Segoe UI', system-ui, -apple-system, sans-serif">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#475569"/>
    </marker>
    <marker id="arrow-blue" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/>
    </marker>
    <filter id="shadow" x="-2%" y="-2%" width="104%" height="104%">
      <feDropShadow dx="1" dy="2" stdDeviation="3" flood-opacity="0.1"/>
    </filter>
    <linearGradient id="bgGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#f8fafc"/>
      <stop offset="100%" stop-color="#f1f5f9"/>
    </linearGradient>
  </defs>

  <!-- Background -->
  <rect width="960" height="720" rx="12" fill="url(#bgGrad)"/>

  <!-- Title -->
  <text x="480" y="36" text-anchor="middle" font-size="18" font-weight="700" fill="#0f172a">peon-ping — Hook Engine Architecture</text>

  <!-- ═══════════════════════════════════════════════ -->
  <!-- CLAUDE CODE BOX -->
  <!-- ═══════════════════════════════════════════════ -->
  <rect x="30" y="56" width="200" height="180" rx="10" fill="#ffffff" stroke="#6366f1" stroke-width="2" filter="url(#shadow)"/>
  <rect x="30" y="56" width="200" height="32" rx="10" fill="#6366f1"/>
  <rect x="30" y="78" width="200" height="10" fill="#6366f1"/>
  <text x="130" y="77" text-anchor="middle" font-size="13" font-weight="600" fill="#ffffff">Claude Code</text>

  <text x="50" y="108" font-size="11" fill="#334155">Lifecycle Events:</text>
  <text x="58" y="125" font-size="10" font-family="monospace" fill="#6366f1">SessionStart</text>
  <text x="58" y="140" font-size="10" font-family="monospace" fill="#6366f1">UserPromptSubmit</text>
  <text x="58" y="155" font-size="10" font-family="monospace" fill="#6366f1">Stop</text>
  <text x="58" y="170" font-size="10" font-family="monospace" fill="#6366f1">PermissionRequest</text>
  <text x="58" y="185" font-size="10" font-family="monospace" fill="#6366f1">Notification</text>
  <text x="58" y="200" font-size="10" font-family="monospace" fill="#6366f1">SessionEnd</text>

  <!-- Arrow: Claude Code → settings.json -->
  <line x1="130" y1="236" x2="130" y2="270" stroke="#475569" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- settings.json -->
  <rect x="50" y="272" width="160" height="44" rx="6" fill="#fef3c7" stroke="#f59e0b" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="130" y="290" text-anchor="middle" font-size="10" font-family="monospace" fill="#92400e">~/.claude/</text>
  <text x="130" y="305" text-anchor="middle" font-size="11" font-weight="600" fill="#92400e">settings.json</text>

  <!-- Arrow: settings.json → peon.sh label -->
  <text x="130" y="334" text-anchor="middle" font-size="9" fill="#64748b">registers hooks →</text>

  <!-- ═══════════════════════════════════════════════ -->
  <!-- JSON STDIN ARROW -->
  <!-- ═══════════════════════════════════════════════ -->
  <line x1="230" y1="146" x2="310" y2="146" stroke="#475569" stroke-width="2" marker-end="url(#arrow)"/>
  <text x="270" y="138" text-anchor="middle" font-size="9" fill="#64748b">JSON</text>
  <text x="270" y="150" text-anchor="middle" font-size="9" fill="#64748b">stdin</text>

  <!-- ═══════════════════════════════════════════════ -->
  <!-- PEON.SH - MAIN ENGINE -->
  <!-- ═══════════════════════════════════════════════ -->
  <rect x="315" y="56" width="330" height="310" rx="10" fill="#ffffff" stroke="#10b981" stroke-width="2" filter="url(#shadow)"/>
  <rect x="315" y="56" width="330" height="32" rx="10" fill="#10b981"/>
  <rect x="315" y="78" width="330" height="10" fill="#10b981"/>
  <text x="480" y="77" text-anchor="middle" font-size="13" font-weight="600" fill="#ffffff">peon.sh — Main Engine</text>

  <!-- Python block -->
  <rect x="335" y="98" width="290" height="175" rx="6" fill="#eff6ff" stroke="#3b82f6" stroke-width="1" stroke-dasharray="4,2"/>
  <text x="480" y="115" text-anchor="middle" font-size="11" font-weight="600" fill="#1e40af">Embedded Python Block</text>
  <text x="480" y="130" text-anchor="middle" font-size="9" fill="#64748b">(single invocation, ~50ms)</text>

  <text x="352" y="150" font-size="10" fill="#334155">1. Load config.json</text>
  <text x="352" y="166" font-size="10" fill="#334155">2. Parse event JSON</text>
  <text x="352" y="182" font-size="10" fill="#334155">3. Agent detection (suppress delegates)</text>
  <text x="352" y="198" font-size="10" fill="#334155">4. Pack rotation (random/round-robin)</text>
  <text x="352" y="214" font-size="10" fill="#334155">5. Map event → CESP category</text>
  <text x="352" y="230" font-size="10" fill="#334155">6. Pick sound (no-repeat)</text>
  <text x="352" y="246" font-size="10" fill="#334155">7. Write .state.json</text>
  <text x="352" y="262" font-size="10" fill="#334155">8. Output shell vars (eval'd)</text>

  <!-- Shell execution block -->
  <rect x="335" y="282" width="290" height="72" rx="6" fill="#f0fdf4" stroke="#22c55e" stroke-width="1" stroke-dasharray="4,2"/>
  <text x="480" y="299" text-anchor="middle" font-size="11" font-weight="600" fill="#166534">Shell Execution (async)</text>
  <text x="352" y="316" font-size="10" fill="#334155">Tab title (ANSI escape → /dev/tty)</text>
  <text x="352" y="332" font-size="10" fill="#334155">Audio playback (platform-dispatched)</text>
  <text x="352" y="348" font-size="10" fill="#334155">Notifications (desktop + mobile)</text>

  <!-- ═══════════════════════════════════════════════ -->
  <!-- CONFIG + STATE FILES -->
  <!-- ═══════════════════════════════════════════════ -->
  <rect x="335" y="385" width="130" height="44" rx="6" fill="#fef3c7" stroke="#f59e0b" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="400" y="404" text-anchor="middle" font-size="11" font-weight="600" fill="#92400e">config.json</text>
  <text x="400" y="418" text-anchor="middle" font-size="9" fill="#92400e">volume, packs, categories</text>

  <rect x="495" y="385" width="130" height="44" rx="6" fill="#fce7f3" stroke="#ec4899" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="560" y="404" text-anchor="middle" font-size="11" font-weight="600" fill="#9d174d">.state.json</text>
  <text x="560" y="418" text-anchor="middle" font-size="9" fill="#9d174d">sessions, last-played</text>

  <!-- Arrows to config/state -->
  <line x1="400" y1="366" x2="400" y2="383" stroke="#f59e0b" stroke-width="1" marker-end="url(#arrow)"/>
  <line x1="560" y1="366" x2="560" y2="383" stroke="#ec4899" stroke-width="1" marker-end="url(#arrow)"/>

  <!-- ═══════════════════════════════════════════════ -->
  <!-- OUTPUT TARGETS -->
  <!-- ═══════════════════════════════════════════════ -->

  <!-- Audio Playback -->
  <rect x="690" y="56" width="240" height="162" rx="10" fill="#ffffff" stroke="#f97316" stroke-width="2" filter="url(#shadow)"/>
  <rect x="690" y="56" width="240" height="32" rx="10" fill="#f97316"/>
  <rect x="690" y="78" width="240" height="10" fill="#f97316"/>
  <text x="810" y="77" text-anchor="middle" font-size="13" font-weight="600" fill="#ffffff">Audio Playback</text>

  <text x="708" y="106" font-size="10" fill="#334155">macOS:</text>
  <text x="770" y="106" font-size="10" font-family="monospace" fill="#ea580c">afplay</text>
  <text x="708" y="122" font-size="10" fill="#334155">Linux:</text>
  <text x="770" y="122" font-size="10" font-family="monospace" fill="#ea580c">pw-play → paplay → ...</text>
  <text x="708" y="138" font-size="10" fill="#334155">WSL:</text>
  <text x="770" y="138" font-size="10" font-family="monospace" fill="#ea580c">PowerShell MediaPlayer</text>
  <text x="708" y="154" font-size="10" fill="#334155">SSH:</text>
  <text x="770" y="154" font-size="10" font-family="monospace" fill="#ea580c">curl → relay.sh</text>
  <text x="708" y="170" font-size="10" fill="#334155">Container:</text>
  <text x="790" y="170" font-size="10" font-family="monospace" fill="#ea580c">curl → relay.sh</text>

  <text x="810" y="196" text-anchor="middle" font-size="9" fill="#64748b">nohup &amp; disown (non-blocking)</text>
  <text x="810" y="210" text-anchor="middle" font-size="9" fill="#64748b">kill_previous_sound() on new event</text>

  <!-- Arrow: engine → audio -->
  <line x1="645" y1="120" x2="688" y2="120" stroke="#f97316" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Desktop Notifications -->
  <rect x="690" y="238" width="240" height="100" rx="10" fill="#ffffff" stroke="#8b5cf6" stroke-width="2" filter="url(#shadow)"/>
  <rect x="690" y="238" width="240" height="32" rx="10" fill="#8b5cf6"/>
  <rect x="690" y="260" width="240" height="10" fill="#8b5cf6"/>
  <text x="810" y="259" text-anchor="middle" font-size="13" font-weight="600" fill="#ffffff">Desktop Notifications</text>

  <text x="708" y="290" font-size="10" fill="#334155">Only when terminal not focused</text>
  <text x="708" y="306" font-size="10" fill="#64748b">macOS: osascript / terminal-notifier</text>
  <text x="708" y="322" font-size="10" fill="#64748b">Linux: notify-send</text>
  <text x="708" y="338" font-size="10" fill="#64748b">WSL: WinForms popup</text>

  <!-- Arrow: engine → notifications -->
  <line x1="645" y1="300" x2="688" y2="290" stroke="#8b5cf6" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Mobile Push -->
  <rect x="690" y="356" width="240" height="76" rx="10" fill="#ffffff" stroke="#06b6d4" stroke-width="2" filter="url(#shadow)"/>
  <rect x="690" y="356" width="240" height="32" rx="10" fill="#06b6d4"/>
  <rect x="690" y="378" width="240" height="10" fill="#06b6d4"/>
  <text x="810" y="377" text-anchor="middle" font-size="13" font-weight="600" fill="#ffffff">Mobile Push</text>

  <text x="708" y="406" font-size="10" fill="#64748b">ntfy.sh / Pushover / Telegram</text>
  <text x="708" y="422" font-size="10" fill="#64748b">Always fires (regardless of focus)</text>

  <!-- Arrow: engine → mobile -->
  <line x1="645" y1="340" x2="710" y2="370" stroke="#06b6d4" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- ═══════════════════════════════════════════════ -->
  <!-- PACK SYSTEM -->
  <!-- ═══════════════════════════════════════════════ -->
  <rect x="30" y="460" width="290" height="120" rx="10" fill="#ffffff" stroke="#10b981" stroke-width="2" filter="url(#shadow)"/>
  <rect x="30" y="460" width="290" height="32" rx="10" fill="#10b981"/>
  <rect x="30" y="482" width="290" height="10" fill="#10b981"/>
  <text x="175" y="481" text-anchor="middle" font-size="13" font-weight="600" fill="#ffffff">Sound Packs (CESP v1.0)</text>

  <text x="48" y="510" font-size="10" font-family="monospace" fill="#334155">packs/peon/openpeon.json</text>
  <text x="48" y="526" font-size="10" fill="#64748b">categories.session.start.sounds[].file</text>
  <text x="48" y="542" font-size="10" fill="#64748b">categories.task.complete.sounds[].file</text>
  <text x="48" y="558" font-size="10" fill="#64748b">categories.input.required.sounds[].file</text>
  <text x="48" y="574" font-size="10" fill="#64748b">categories.user.spam.sounds[].file</text>

  <!-- Arrow: packs → engine -->
  <line x1="280" y1="460" x2="400" y2="385" stroke="#10b981" stroke-width="1.5" stroke-dasharray="6,3" marker-end="url(#arrow)"/>

  <!-- ═══════════════════════════════════════════════ -->
  <!-- MULTI-IDE ADAPTERS -->
  <!-- ═══════════════════════════════════════════════ -->
  <rect x="350" y="460" width="280" height="120" rx="10" fill="#ffffff" stroke="#6366f1" stroke-width="2" filter="url(#shadow)"/>
  <rect x="350" y="460" width="280" height="32" rx="10" fill="#6366f1"/>
  <rect x="350" y="482" width="280" height="10" fill="#6366f1"/>
  <text x="490" y="481" text-anchor="middle" font-size="13" font-weight="600" fill="#ffffff">Multi-IDE Adapters</text>

  <text x="368" y="510" font-size="10" fill="#334155">Codex</text>
  <text x="425" y="510" font-size="10" fill="#64748b">adapters/codex.sh</text>
  <text x="368" y="526" font-size="10" fill="#334155">Cursor</text>
  <text x="425" y="526" font-size="10" fill="#64748b">inline _cursor_event_map</text>
  <text x="368" y="542" font-size="10" fill="#334155">OpenCode</text>
  <text x="437" y="542" font-size="10" fill="#64748b">peon-ping.ts (TypeScript)</text>
  <text x="368" y="558" font-size="10" fill="#334155">Kiro</text>
  <text x="425" y="558" font-size="10" fill="#64748b">adapters/kiro.sh</text>
  <text x="368" y="574" font-size="10" fill="#334155">Windsurf</text>
  <text x="437" y="574" font-size="10" fill="#64748b">adapters/windsurf.sh</text>

  <!-- Arrow: adapters → engine -->
  <path d="M 490 460 L 490 430 L 480 370" stroke="#6366f1" stroke-width="1.5" stroke-dasharray="6,3" fill="none" marker-end="url(#arrow)"/>
  <text x="510" y="440" font-size="9" fill="#64748b">translate to CESP JSON</text>

  <!-- ═══════════════════════════════════════════════ -->
  <!-- RELAY SERVER -->
  <!-- ═══════════════════════════════════════════════ -->
  <rect x="660" y="460" width="270" height="120" rx="10" fill="#ffffff" stroke="#ef4444" stroke-width="2" filter="url(#shadow)"/>
  <rect x="660" y="460" width="270" height="32" rx="10" fill="#ef4444"/>
  <rect x="660" y="482" width="270" height="10" fill="#ef4444"/>
  <text x="795" y="481" text-anchor="middle" font-size="13" font-weight="600" fill="#ffffff">relay.sh (Remote Audio)</text>

  <text x="678" y="510" font-size="10" fill="#334155">HTTP server on localhost:19998</text>
  <text x="678" y="526" font-size="10" fill="#64748b">GET /play?file=... or ?category=...</text>
  <text x="678" y="542" font-size="10" fill="#64748b">POST /notify (desktop notification)</text>
  <text x="678" y="558" font-size="10" fill="#64748b">SSH: port-forwarded via -R 19998</text>
  <text x="678" y="574" font-size="10" fill="#64748b">Container: host.docker.internal</text>

  <!-- ═══════════════════════════════════════════════ -->
  <!-- EVENT ROUTING LEGEND -->
  <!-- ═══════════════════════════════════════════════ -->
  <rect x="30" y="600" width="900" height="106" rx="10" fill="#ffffff" stroke="#cbd5e1" stroke-width="1" filter="url(#shadow)"/>
  <text x="480" y="622" text-anchor="middle" font-size="12" font-weight="600" fill="#0f172a">Event → CESP Category Routing</text>

  <text x="60" y="648" font-size="10" font-family="monospace" fill="#6366f1">SessionStart</text>
  <text x="170" y="648" font-size="10" fill="#475569">→</text>
  <text x="185" y="648" font-size="10" font-family="monospace" fill="#10b981">session.start</text>
  <text x="310" y="648" font-size="10" fill="#64748b">"Ready to work?"</text>

  <text x="480" y="648" font-size="10" font-family="monospace" fill="#6366f1">Stop</text>
  <text x="520" y="648" font-size="10" fill="#475569">→</text>
  <text x="535" y="648" font-size="10" font-family="monospace" fill="#10b981">task.complete</text>
  <text x="660" y="648" font-size="10" fill="#64748b">"Work, work."</text>

  <text x="60" y="670" font-size="10" font-family="monospace" fill="#6366f1">PermissionRequest</text>
  <text x="200" y="670" font-size="10" fill="#475569">→</text>
  <text x="215" y="670" font-size="10" font-family="monospace" fill="#10b981">input.required</text>
  <text x="340" y="670" font-size="10" fill="#64748b">"Something need doing?"</text>

  <text x="480" y="670" font-size="10" font-family="monospace" fill="#6366f1">UserPromptSubmit</text>
  <text x="620" y="670" font-size="10" fill="#475569">→</text>
  <text x="635" y="670" font-size="10" font-family="monospace" fill="#10b981">user.spam</text>
  <text x="735" y="670" font-size="10" fill="#64748b">"Me busy!" (3+ in 10s)</text>

  <text x="60" y="692" font-size="10" font-family="monospace" fill="#6366f1">Notification</text>
  <text x="160" y="692" font-size="10" fill="#475569">→</text>
  <text x="175" y="692" font-size="10" fill="#64748b">tab title only (no sound)</text>

  <text x="480" y="692" font-size="10" font-family="monospace" fill="#6366f1">SessionEnd</text>
  <text x="570" y="692" font-size="10" fill="#475569">→</text>
  <text x="585" y="692" font-size="10" fill="#64748b">cleanup state (no output)</text>
</svg>
